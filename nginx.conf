user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # Basic Settings
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout  65;

    # Logging
    access_log  /var/log/nginx/access.log;
    error_log   /var/log/nginx/error.log;

    # Gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;

    # Default catch-all servers
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;
        return 444;
    }

    server {
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;
        server_name _;
        ssl_certificate     /etc/ssl/certs/cfo_cert_bread.pem;
        ssl_certificate_key /etc/ssl/certs/cfo_key_bread.pem;
        return 444;
    }

    # HTTP server block for safinoapp.ir (port 80)
    server {
        listen 80;
        server_name safinoapp.ir;
        
        # Fix double slashes first
        rewrite ^//(.*)$ /$1 permanent;
        
        # Special handling for callback URLs
        
        
        # For callback URLs: direct to app subdomain (HTTPS)
        location ~* ^/account/callback/(.*)$ {
            return 301 https://app.safinoapp.ir/account/callback/$1$is_args$args;
        }
        # General HTTP to HTTPS redirect for all other requests
        location / {
            return 301 https://safinoapp.ir$request_uri;
        }
    }

    # HTTPS server block for safinoapp.ir (port 443)
    server {
        listen 443 ssl;
        server_name safinoapp.ir;
        
        ssl_certificate     /etc/ssl/certs/cfo_cert_bread.pem;
        ssl_certificate_key /etc/ssl/certs/cfo_key_bread.pem;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256";
        

        # Fix double slashes in all URLs
        location ~* ^/account/callback/(.*)$ {
            return 301 https://app.safinoapp.ir/account/callback/$1$is_args$args;
        }

        location / {
            # Your existing configuration
            # proxy_pass, root, etc.
        }
    }

    include /etc/nginx/bread.conf;
}
# user www-data;
# worker_processes auto;
# pid /run/nginx.pid;

# events {
#     worker_connections 1024;
# }

# http {
#     # Basic Settings
#     include       /etc/nginx/mime.types;
#     default_type  application/octet-stream;
#     sendfile      on;
#     keepalive_timeout  65;

#     # Logging
#     access_log  /var/log/nginx/access.log;
#     error_log   /var/log/nginx/error.log;

#     # Gzip
#     gzip on;
#     gzip_types text/plain text/css application/json application/javascript;

#     # Default catch-all servers (for unmatched requests)
#     server {
#         listen 80 default_server;
#         listen [::]:80 default_server;
#         server_name _;
#         return 444;  # Close connection
#     }

#     server {
#         listen 443 ssl default_server;
#         listen [::]:443 ssl default_server;
#         server_name _;
#         ssl_certificate     /etc/ssl/certs/cfo_cert_bread.pem;
#         ssl_certificate_key /etc/ssl/certs/cfo_key_bread.pem;
#         return 444;
#     }

#     # Include bread configuration
#     include /etc/nginx/bread.conf;
# }